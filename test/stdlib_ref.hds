import hades.internal.ref_counting as rc;
import libc as c;
import submodule.test_utils as u;

def main(): Void {
    val x = rc.alloc(5, print_message);
    c.puts(b"allocated");
    u.print_size(*x.m_count);

    c.puts(b"retain");
    rc.retain(x);
    u.print_size(*x.m_count);

    c.puts(b"release");
    rc.release(x);
    u.print_size(*x.m_count);

    c.puts(b"release");
    rc.release(x);
}

def print_message(void: *mut Void): Void {
    c.puts(b"destructor");
}